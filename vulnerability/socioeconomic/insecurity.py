import pandas as pd

from base.objects import Indicator, ConfigParser, GlobalBaseGrid
from base.datasets import SDGData
from utils.data_processing import default_impute, min_max_scaling, process_yearly_data


class VulSocioeconomicInsecurity(Indicator):
    def __init__(
        self,
        config: ConfigParser,
        grid: GlobalBaseGrid,
        pillar: str = "VUL",
        dim: str = "socioeconomic",
        id: str = "insecurity",
    ):
        """Params defining indicator's place in index set to designed hierarchy by default"""
        self.sdg = SDGData(config=config)
        super().__init__(pillar=pillar, dim=dim, id=id, config=config, grid=grid)

    def load_data(self) -> pd.DataFrame:
        df_sdg = self.sdg.load_data(["SH_STA_WAST", "SN_STA_OVWGT"])
        return df_sdg

    def preprocess_data(self, df_sdg: pd.DataFrame) -> pd.DataFrame:
        df_sdg = self.sdg.preprocess_data(df_sdg)
        # percent to percentage
        df_sdg["SH_STA_WAST"] = df_sdg["SH_STA_WAST"] / 100
        df_sdg["SN_STA_OVWGT"] = df_sdg["SN_STA_OVWGT"] / 100
        df_sdg = default_impute(df_sdg, "year", "iso3")
        return df_sdg

    def create_indicator(self, df_sdg: pd.DataFrame) -> tuple[pd.DataFrame, pd.DataFrame]:
        df_sdg[self.composite_id] = df_sdg["SH_STA_WAST"] + df_sdg["SN_STA_OVWGT"]
        df_base = self.create_base_df()
        df_indicator = process_yearly_data(df_base, df_sdg, [self.composite_id])
        return df_indicator, df_sdg

    def normalize(self, input_data: tuple[pd.DataFrame, pd.DataFrame]) -> pd.DataFrame:
        df_indicator, df_sdg = input_data
        upper_limits = df_sdg.loc[(slice(None), slice(None, 2020)), self.composite_id].quantile(
            0.99
        )
        df_indicator[self.composite_id] = min_max_scaling(
            df_indicator[self.composite_id], minv=0, maxv=upper_limits
        )
        return df_indicator[[self.composite_id]]


if __name__ == "__main__":
    config = ConfigParser()
    grid = GlobalBaseGrid(config)
    indicator = VulSocioeconomicInsecurity(config=config, grid=grid)
    indicator.run()
